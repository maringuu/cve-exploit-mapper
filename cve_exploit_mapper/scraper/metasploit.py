"""Scrapes information from the metasploit-framework"""

import subprocess as sp
import pandas as pd
from io import StringIO
from pathlib import Path


def download_to_path(_path):
    path = Path(_path)
    if path.exists():
        sp.run(
            f"GIT_DIR={path}/.git git pull",
            shell=True,
            stdout=sp.DEVNULL,
            stderr=sp.DEVNULL,
            check=True,
        )
    else:
        sp.run(
            f"git clone https://github.com/rapid7/metasploit-framework {path}",
            shell=True,
            stdout=sp.DEVNULL,
            stderr=sp.DEVNULL,
            check=True,
        )


def dataframe_from_directory(path):
    fd_process = sp.run(
        # Iterate over all ruby files in the metasploit-framework and grep for CVEs.
        # Metasploit modules that relate to a CVE have the CVE id in their constructor.
        f"cd {path} && " + r"""fdfind -e rb -x rg --with-filename --only-matching "CVE', '\d+-\d+" '{}' | sed "s/', '/-/" """,
        shell=True,
        stdout=sp.PIPE,
        stderr=sp.DEVNULL,
        check=True,
        text=True,
    )

    df = pd.read_csv(
        StringIO(fd_process.stdout),
        index_col=False,
        sep=":",
        names=["script", "cve"]
    )
    # TODO find out the actual commit we are using
    commit = "master"

    df["exploit-link"] = f"https://github.com/rapid7/metasploit-framework/tree/{commit}/" + df["script"]
    df["source"] = df["exploit-link"]

    return df[["cve", "exploit-link", "source"]]
